<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cheque Management Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .card-stats {
            transition: transform 0.2s;
            border: none;
            border-radius: 10px;
        }
        .card-stats:hover {
            transform: translateY(-5px);
        }
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-ready {
            background-color: #d4edda;
            color: #155724;
        }
        .status-processing {
            background-color: #fff3cd;
            color: #856404;
        }
        .status-pending {
            background-color: #f8f9fa;
            color: #383d41;
        }
        .table-container {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 10px;
            margin-top: 20px;
        }
        .empty-state i {
            font-size: 48px;
            color: #6c757d;
            margin-bottom: 20px;
        }
        .search-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .table th {
            border-top: none;
            font-weight: 600;
            color: #495057;
        }
        .offline-alert {
            display: none;
            margin-bottom: 20px;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand font-weight-bold" href="#">
                <i class="fas fa-file-invoice-dollar mr-2"></i>
                Cheque Management System
            </a>
            <div class="ml-auto">
                <span id="connectionStatus" class="badge badge-success">Online</span>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <!-- Offline Alert -->
        <div class="alert alert-warning offline-alert" id="offlineAlert" role="alert">
            <i class="fas fa-wifi mr-2"></i>
            You are currently offline. Some features may be limited.
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card card-stats shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="text-muted">Total Cheques</h6>
                                <h3 id="totalCheques">0</h3>
                            </div>
                            <div class="bg-primary p-3 rounded">
                                <i class="fas fa-file-invoice text-white"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card card-stats shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="text-muted">Ready</h6>
                                <h3 id="readyCheques">0</h3>
                            </div>
                            <div class="bg-success p-3 rounded">
                                <i class="fas fa-check-circle text-white"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card card-stats shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="text-muted">Processing</h6>
                                <h3 id="processingCheques">0</h3>
                            </div>
                            <div class="bg-warning p-3 rounded">
                                <i class="fas fa-clock text-white"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card card-stats shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="text-muted">Total Amount</h6>
                                <h3 id="totalAmount">â‚¨ 0</h3>
                            </div>
                            <div class="bg-info p-3 rounded">
                                <i class="fas fa-money-bill-wave text-white"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Box -->
        <div class="search-container">
            <div class="row">
                <div class="col-md-8">
                    <div class="input-group">
                        <input type="text" id="search" class="form-control" placeholder="Search cheques...">
                        <div class="input-group-append">
                            <button class="btn btn-primary" id="searchBtn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-right">
                    <button class="btn btn-secondary" id="resetBtn">
                        <i class="fas fa-sync-alt mr-1"></i>
                        Reset
                    </button>
                </div>
            </div>
        </div>

        <!-- Table Container -->
        <div class="table-container">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>NARRATION</th>
                            <th>AMOUNT</th>
                            <th>CHEQUE NO</th>
                            <th>NAR</th>
                            <th>STATUS</th>
                        </tr>
                    </thead>
                    <tbody id="checksTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state">
            <i class="fas fa-search mb-3"></i>
            <h4>No Results Found</h4>
            <p class="text-muted">Try adjusting your search terms or clear the filter</p>
        </div>
    </div>

    <script>
        // Service Worker registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swPath = '/accounts.office.cheque.inquiry-test/service-worker.js';
                
                navigator.serviceWorker.register(swPath, {
                    scope: '/accounts.office.cheque.inquiry-test/'
                })
                .then(registration => {
                    console.log('ServiceWorker registration successful with scope:', registration.scope);
                })
                .catch(err => {
                    console.error('ServiceWorker registration failed:', err);
                });
            });
        }

        // Handle online/offline status
        function updateOnlineStatus() {
            const status = navigator.onLine;
            document.getElementById('connectionStatus').className = 
                status ? 'badge badge-success' : 'badge badge-danger';
            document.getElementById('connectionStatus').textContent = 
                status ? 'Online' : 'Offline';
            document.getElementById('offlineAlert').style.display = 
                status ? 'none' : 'block';
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
    </script>

    <!-- XMLTableHandler Implementation -->
    <script>
        class XMLTableHandler {
            constructor() {
                this.tableBody = document.getElementById('checksTable');
                this.searchInput = document.getElementById('search');
                this.tableContainer = document.querySelector('.table-container');
                this.emptyState = document.getElementById('emptyState');
                this.stats = {
                    totalCheques: document.getElementById('totalCheques'),
                    readyCheques: document.getElementById('readyCheques'),
                    processingCheques: document.getElementById('processingCheques'),
                    totalAmount: document.getElementById('totalAmount'),
                };

                this.initializeEventListeners();
                this.fetchXMLData();
            }

            initializeEventListeners() {
                this.searchInput.addEventListener('input', () => this.searchAndFilterXML());
                document.getElementById('searchBtn').addEventListener('click', () => this.searchAndFilterXML());
                document.getElementById('resetBtn').addEventListener('click', () => this.resetTable());
            }

            async fetchXMLData() {
                try {
                    // const response = await fetch('/data/sample.xml');
                    const response = await fetch('/accounts.office.cheque.inquiry/public/data/files.json');
                    if (!response.ok) throw new Error('Network response was not ok');
                    const xmlString = await response.text();
                    this.parseXMLToTable(xmlString);
                } catch (error) {
                    console.error('Error fetching XML:', error);
                    this.showError('Failed to load data. Please try again.');
                }
            }

            parseXMLToTable(xmlString) {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlString, 'text/xml');
                const gPvnElements = xmlDoc.getElementsByTagName('G_PVN');

                this.tableBody.innerHTML = '';

                if (gPvnElements.length === 0) {
                    this.showEmptyState();
                    return;
                }

                Array.from(gPvnElements).forEach(element => {
                    const row = this.createTableRow(element);
                    this.tableBody.appendChild(row);
                });

                this.updateStats();
                this.tableContainer.style.display = 'block';
                this.emptyState.style.display = 'none';
            }

            createTableRow(element) {
                const row = document.createElement('tr');
                const fields = ['NARRATION', 'AMOUNT', 'CHEQ_NO', 'NAR', 'DD'];

                fields.forEach(field => {
                    const cell = document.createElement('td');
                    let value = element.getElementsByTagName(field)[0]?.textContent.trim() || '';
                    
                    if (field === 'AMOUNT') {
                        value = `â‚¨ ${parseFloat(value).toLocaleString()}`;
                    } else if (field === 'DD') {
                        const status = value.toLowerCase();
                        const statusClass = status.includes('ready') ? 'status-ready' 
                            : status.includes('processing') ? 'status-processing' 
                            : 'status-pending';
                        cell.innerHTML = `<span class="status-badge ${statusClass}">${value}</span>`;
                        return;
                    }
                    
                    cell.textContent = value;
                    row.appendChild(cell);
                });

                return row;
            }

            searchAndFilterXML() {
                const searchTerm = this.searchInput.value.toLowerCase();
                const rows = this.tableBody.querySelectorAll('tr');
                let matchCount = 0;

                rows.forEach(row => {
                    const cells = row.getElementsByTagName('td');
                    const matchesSearch = Array.from(cells).some(cell => 
                        cell.textContent.toLowerCase().includes(searchTerm)
                    );
                    row.style.display = matchesSearch ? '' : 'none';
                    if (matchesSearch) matchCount++;
                });

                this.emptyState.style.display = matchCount === 0 ? 'block' : 'none';
                this.tableContainer.style.display = matchCount === 0 ? 'none' : 'block';
                this.updateStats();
            }

            updateStats() {
                const rows = this.tableBody.querySelectorAll('tr');
                const visibleRows = Array.from(rows).filter(row => row.style.display !== 'none');

                const stats = {
                    total: visibleRows.length,
                    ready: visibleRows.filter(row => 
                        row.querySelector('.status-badge').textContent.toLowerCase().includes('ready')
                    ).length,
                    processing: visibleRows.filter(row => 
                        row.querySelector('.status-badge').textContent.toLowerCase().includes('processing')
                    ).length,
                    totalAmount: visibleRows.reduce((sum, row) => 
                        sum + parseFloat(row.cells[1].textContent.replace(/[^0-9.]/g, '')), 0
                    ),
                };

                this.stats.totalCheques.textContent = stats.total;
                this.stats.readyCheques.textContent = stats.ready;
                this.stats.processingCheques.textContent = stats.processing;
                this.stats.totalAmount.textContent = `â‚¨ ${stats.totalAmount.toLocaleString()}`;
            }

            resetTable() {
                this.searchInput.value = '';
                this.tableBody.querySelectorAll('tr').forEach(row => row.style.display = '');
                this.tableContainer.style.display = 'block';
                this.emptyState.style.display = 'none';
                this.updateStats();
            }

            showError(message) {
                const alert = document.createElement('div');
                alert.className = 'alert alert-danger alert-dismissible fade show';
                alert.innerHTML = `
                    ${message}
                    <button type="button" class="close" data-dismiss="alert">
                        <span>&times;</span>
                    </button>
                `;
                document.querySelector('.container').insertBefore(alert, document.querySelector('.row'));
            }

            showEmptyState() {
                this.tableContainer.style.display = 'none';
                this.emptyState.style.display = 'block';
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            new XMLTableHandler();
        });
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com</antArtifact>
